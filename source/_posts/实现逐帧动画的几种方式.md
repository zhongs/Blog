---
title: 实现逐帧动画的几种方式
date: 2017-10-23 22:31:18
tags: 帧动画
---
<img src="http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/timg.jpg" width="80%" height="50%">
公司有个特效师，专门做这样的帧动画图片，做好后就给到前端，来实现一张一张图片切换播放的动画；我用了canvas，css的animation，图片的image标签，以及图片转码base64的几种方式，分别实现了逐帧动画效果；
<!-- more -->
## 用canvas实现
### 动画效果
![动画效果](http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/ani.gif)
![图片](http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/img.png)
[canvas demo地址](https://zhongs.github.io/frame-animation/canvas/index.html)
### 首先加载设计师给我的图片
````javascript
    //1.创建要加载的图片
    var imgs = function() {
        var imgsArr = [];
        for (var i = 1; i < 21; i++) {
            var imgSrc = `./img/${i}.png`;
            imgsArr.push(imgSrc);
        }
        return imgsArr;
    }

    //2.加载图片
    var loadImgs = function(fn) {
        var loaded = 0; //记录已经加载图片的个数
        var loadedImgsArr = []; //用来存放加载的图片
        var imgsArr = imgs();
        var imgObj = null;
        imgsArr.forEach(function(value, index, arr) {
            imgObj = new Image();
            imgObj.onload = function() {
                loaded++;
                //这里所有的图片加载完成
                if (loaded == imgsArr.length) {
                    fn && fn(loadedImgsArr);
                }
            }
            imgObj.src = imgsArr[index];
            loadedImgsArr.push(imgObj);
        });
    }
    
````
### 使用canvas的drawImage Api
````javascript
    //3.配置参数
    var config = {
        fps: 10, //帧率
        parentBox: document.querySelectorAll('.ani-box')[0]
    }

    //4.创建canvas
    var createCanvas = function() {
        var canvas = document.createElement('canvas');
        config.parentBox.appendChild(canvas);
        var { offsetWidth, offsetHeight } = canvas.parentNode;
        canvas.width = offsetWidth;
        canvas.height = offsetHeight;
        return canvas;
    }

    //5.有了图片和canvas对象，创建动画函数
    var ani = function(imgsArr, cb) {
        var canvas = createCanvas();
        //图片的宽高
        var offsetWidth = imgsArr[0].width;
        var offsetHeight = imgsArr[0].height;
        var ctx = canvas.getContext('2d');
        var n = 0;
        var timer = setInterval(function() {
            //清屏
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            //绘制图片        
            ctx.drawImage(
                imgsArr[n],
                0, 0, offsetWidth, offsetHeight,
                0, 0, canvas.width, canvas.height
            );

            n++;

            //播放到最后一张图片
            if (n == imgsArr.length) {
                n = 0;
                cb && cb(timer);
            }
        }, 1000 / config.fps);
    }
````
### 调用
````javascript
    var init = function() {
        //加载图片，执行动画
        loadImgs(function(imgs) {
            ani(imgs, function(timer) {
                //播放完停留在最后一张
                //clearInterval(timer);
            });
        });
    }
    init();
````


## 用css的animation动画实现
[css demo地址](https://zhongs.github.io/frame-animation/css/index.html)
### 首先需要知道的是有多少张图片,用scss生成css代码,会少写很多代码
````scss
    .animation {
        animation: ani 2s infinite steps(1);
    }

    $img_total: 20;  //图片的总数
    $img_n: 1;       //图片变量名
    $n: 0;           //当前阶段，帧动画
    @-webkit-keyframes ani {
      @while $n <= 100 {
        #{$n}% {
          background-image: url("http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/#{$img_n}.png");
        }
        $img_n: $img_n + 1;
        @if ($img_n>$img_total) {
          $img_n: 1;
        }
        $n: $n + ( 100 / $img_total );
      }
    }
````

### js判断图片是否完成
````javascript
     //1.创建要加载的图片
    var imgs = function() {
        var imgsArr = [];
        for (var i = 1; i < 21; i++) {
            var imgSrc = `http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/${i}.png`;
            imgsArr.push(imgSrc);
        }
        return imgsArr;
    }

    //2.加载图片
    var loadImgs = function(fn) {
        var loaded = 0; //记录已经加载图片的个数
        var loadedImgsArr = []; //用来存放加载的图片
        var imgsArr = imgs();
        var imgObj = null;
        imgsArr.forEach(function(value, index, arr) {
            imgObj = new Image();
            imgObj.onload = function() {
                loaded++;
                //这里所有的图片加载完成
                if (loaded == imgsArr.length) {
                    fn && fn(loadedImgsArr);
                }
            }
            imgObj.src = imgsArr[index];
            loadedImgsArr.push(imgObj);
        });
    }

    //添加class
    loadImgs(function(){
        document.querySelectorAll('.ani-box')[0].className += " animation"
    })
````
## 用img标签的src实现
[image标签实现demo](https://zhongs.github.io/frame-animation/img/index.html)
### 首先还是得确保图片全部加载完成，后面就是替换src的一个过程；
````javascript
 //1.创建要加载的图片
    var imgs = function() {
        var imgsArr = [];
        for (var i = 1; i < 21; i++) {
            var imgSrc = `./img/${i}.png`;
            imgsArr.push(imgSrc);
        }
        return imgsArr;
    }

    //2.加载图片
    var loadImgs = function(fn) {
        var loaded = 0; //记录已经加载图片的个数
        var loadedImgsArr = []; //用来存放加载的图片
        var imgsArr = imgs();
        var imgObj = null;
        imgsArr.forEach(function(value, index, arr) {
            imgObj = new Image();
            imgObj.onload = function() {
                loaded++;
                //这里所有的图片加载完成
                if (loaded == imgsArr.length) {
                    fn && fn(loadedImgsArr);
                }
            }
            imgObj.src = imgsArr[index];
            loadedImgsArr.push(imgObj);
        });
    }

    var config = {
        fps: 10, //每秒10帧
        box: document.querySelector('.ani-box')
    }

    //创建图片标签
    function createImg() {
        var img = document.createElement('img');
        config.box.appendChild(img);
        return img;
    }

    //定时器来播放图片
    function run(imgArr, fn) {
        var img = createImg();
        var n = 0;
        var timer = setInterval(function() {
            img.src = imgArr[n].src;
            n++;
            if(n == imgArr.length){
                n = 0;
                fn && fn(timer);
            }
        }, 1000 / config.fps);

    }

    loadImgs(function(imgArr) {
        run(imgArr,function(timer){
            //clearInterval(timer);
        });
    });
````

## 图片转base64的实现
![动画效果](http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/basegif.gif)
[转码base64实现demo](https://zhongs.github.io/frame-animation/imgBase64/index.html)
### 需要的文件格式
![图片](http://7xqrwh.com1.z0.glb.clouddn.com/image/frameAni/base64.jpg)
### 这种实现方式需要，先把图片转成base64格式的；遇到的问题是没有找到，现成的工具转换我需要的格式，于是自己写了个简单的js文件，用nodejs来实现转码任务；
### toBase64.js转码文件
在cmd命令行，进入当前toBase64.js文件目录下，执行node toBase64，会在img文件夹下生成base64.js文件
````javascript
    var fs = require('fs');
    var path = require('path');
    var util = require('util');

    function base64Img(src) {
        var data = fs.readFileSync(src).toString('base64');
        return util.format('data:%s;base64,%s', 'image', data);
    }

    var outputFile = path.join(__dirname, './img/', 'base64.js');

    var isFile = fs.existsSync(outputFile);
    if (isFile) {
        fs.unlinkSync(outputFile);
    }

    var filePath = path.join(__dirname, './img/');
    var data = [];

    var start = 1;
    var end = fs.readdirSync('./img').length;
    for (; start <= end; start++) {
        data[start] = base64Img(filePath + start + '.png');
    }

    data.splice(0, 1);

    var imgData = {
        key: data
    }

    fs.writeFile(outputFile, 'var imgData = '+JSON.stringify(imgData), function(err) {
        if (err) {
            console.log(err);
        } else {
            console.log('Completed!');
        }
    });
````
### js逻辑部分
````javascript
    //引入生成的base64转码文件
    <script src="img/base64.js"></script>
    <script>
    var config = {
        fps: 10, //每秒10帧
        box: document.querySelector('.ani-box')
    }

    //创建图片标签
    function createImg() {
        var img = document.createElement('img');
        config.box.appendChild(img);
        return img;
    }

    //定时器来播放图片
    function run(imgArr, fn) {
        var img = createImg();
        var n = 0;
        var timer = setInterval(function() {
            img.src = imgArr[n];
            n++;
            if (n == imgArr.length) {
                n = 0;
                fn && fn(timer);
            }
        }, 1000 / config.fps);

    }

    run( imgData.key, function(timer) {
        //clearInterval(timer);
    });
    </script>
````
### [所有实现方式源码地址](https://github.com/zhongs/frame-animation)

### 总结
* 4种帧动画的实现方式，原理是大同小异的；
* 图片一张一张的加载，会增加网络请求数量，转码base64文件会有点大，但能减少网络请求；
* 实际开发中，需求可能没这么简单，例如：需要循环播放3次，在停留在最后一张图片上；



