---
title: 视频转码播放实践
date: 2017-11-09 16:25:16
tags: 全屏播放
---
<img align="center" src="http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/bg.jpg" width="80%" height="50%">
在手机微信客户端播放视频，有一个问题很头疼；那就是video标签，在安卓手机自动弹出一个view窗口全屏播放；于是乎想着把视频资源转码成base64格式的数据，来放到页面播放；
<!-- more -->
## 在转码之前要做下面这些事情

### 安装 ffmpeg 
视频的转码要保证自己电脑安装了ffmpeg，首先是下载它。
<a href="http://ffmpeg.zeranoe.com/builds/" target="_blank">软件安装下载地址：</a>

![下载地址](http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/1.png)

下载下来解压，可以把目录重命名，找个位置放着，比如像这样：

![下载地址](http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/2.png)

一般来说解压之后还要配置环境变量，不然你在cmd命令行，输入ffmpeg会出现如下情况：

![下载地址](http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/4.png)

环境变量的配置
复制ffmpeg安装包的bin目录

![下载地址](http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/3.png)

貌似绝大多数，如上图cmd中的问题，都是像下面这样解决；

![下载地址](http://7xqrwh.com1.z0.glb.clouddn.com/image/ffmpeg/5.png)

### 使用nodejs第三方模块ffmpeg 
ffmpeg模块可以把一个视频，按照配置生成许多一帧一帧的图片和音频mp3文件；
之前写过一篇<a href="https://zhongs.github.io/2017/10/23/%E5%AE%9E%E7%8E%B0%E9%80%90%E5%B8%A7%E5%8A%A8%E7%94%BB%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/" target="_blank">《实现逐帧动画的几种方式》</a>的文章，这里我就可以把生成的图片转换成base64格式，然后在用image标签播放

这里是我使用ffmpeg转码视频的部分代码：
app.js 这个是任务入口文件； 进到cmd执行 node app 即可将mp4目录下的文件转换成，我想要的帧动画图片和mp3音频文件，并且分别放在dist目录下；

````javascript
    var fs = require('fs');
    var path = require('path');
    var util = require('util');
    var ff = require('./lib/ff');
    var createBase64 = require('./lib/toBase64');
    var del = require('./lib/delete');
    var config = {
        src_path: path.join(__dirname, './mp4/video.mp4'),
        deleteDirAndFile: path.join(__dirname, './dist/'),
        save_img_path: path.join(__dirname, './dist/img/'),
        save_mp3_path: path.join(__dirname, './dist/mp3/')
    }
    //删除dist目录
    del.deleteAllSync(config.deleteDirAndFile);
    //生成音频文件
    ff.createMp3(config.src_path, config.save_mp3_path);
    //生成图片
    ff.createImg(config.src_path, config.save_img_path, {
        size: '375x667', //生成的图片尺寸
        frame_rate:10 //一秒内捕获的帧数
    }, () => {
        //图片转base64
        createBase64({
            imgPath: config.save_img_path,
            savePath: path.join(__dirname, './dist/'),
            fps:10
        });
    });

````

./lib/ff.js 这个文件负责创建帧动画图片和音频mp3文件

````javascript
    var ffmpeg = require('ffmpeg');
    var del = require('./delete');
    /**
     *  src_path 视频路径
     *  save_path 保存图片的路径
     */
    function createImg(src_path, save_path, config, cb) {

        del.createDirSync(save_path);

        try {
            var process = new ffmpeg(src_path);
            Object.assign(config, {
                file_name: 'img'
            });
            process.then(function(video) {
                // Callback mode
                video.fnExtractFrameToJPG(save_path, config, function(error, files) {
                    if (!error)
                        console.log('视频转图片成功！')
                    cb && cb();
                });
            }, function(err) {
                console.log('Error: ' + err);
            });
        } catch (e) {
            console.log(e.code);
            console.log(e.msg);
        }
    }
    /**
     * src_path 视频路径
     * save_path_name 生成mp3的文件名路径
     */
    function createMp3(src_path, save_path_name, cb) {
        del.createDirSync(save_path_name);
        try {
            var process = new ffmpeg(src_path);
            process.then(function(video) {
                video.fnExtractSoundToMP3(save_path_name + 'music.mp3', function(error, file) {
                    if (!error)
                        console.log('提取视频中的音频成功！')
                    cb && cb()
                });
            }, function(err) {
                console.log('Error: ' + err);
            });
        } catch (e) {
            console.log(e.code);
            console.log(e.msg);
        }
    }
    module.exports = {
        createImg,
        createMp3
    }
````

./lib/delete.js 这个文件有2个方法，用来删除和创建，生成的dist目录

````javascript
    var path = require('path');
    var fs = require('fs');
    function deleteAllSync(path) {
        //如果文件存在，则返回 true，否则返回 false。
        if (fs.existsSync(path)) {
            //返回一个不包括 '.' 和 '..' 的文件名的数组
            fs.readdirSync(path).forEach(function(file, index) {
                var curPath = path + "/" + file;
                /**
                 * fs.statSync(curPath)  返回一个 fs.Stats 实例
                 * 是目录 递归调用
                 * 不是目录 删除文件
                 */
                if (fs.statSync(curPath).isDirectory()) { // recurse  
                    deleteAllSync(curPath);
                } else { // delete file  
                    fs.unlinkSync(curPath);
                }
            });
            fs.rmdirSync(path);
        }
    }
    //递归创建目录 同步方法
    function createDirSync(dirname) {
        // console.log(dirname);
        if (fs.existsSync(dirname)) {
            return true;
        } else {
            if (createDirSync(path.dirname(dirname))) {
                fs.mkdirSync(dirname);
                return true;
            }
        }
    }
    module.exports = {
        deleteAllSync,
        createDirSync
    }
````

## 前台页面

index.html 是前端页面逻辑

````javascript
    var music = document.getElementById("mp3");
    var config = {
        box: document.querySelector('.ani-box')
    }
    /**
     * Audio/Video DOM 事件 在ios上无效；
     * 
     * ios 要播放音频才能监听到DOM事件，不播放监听不到；
     * 安卓 不播放就可以，监听DOM 事件；
     */
    music.play();
    music.pause();
    document.addEventListener("WeixinJSBridgeReady", function() {
        WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
            music.play();
            music.pause();
        });
    }, false);

    //创建图片标签
    function createImg() {
        var img = document.createElement('img');
        config.box.appendChild(img);
        return img;
    }

    //定时器来播放图片
    function run(imgArr, fn) {
        var img = createImg();
        var n = 0;
        var timer = setInterval(function() {
            img.src = imgArr[n];
            n++;
            if (n == imgArr.length) {
                n = 0;
                fn && fn(timer);
            }
        }, 1000 / imgData.fps);
    }

    //动态加载js文件
    function pLoadJs(url) {
        return new Promise(function(resolve, reject) {
            var script = document.createElement('script');　　　　
            script.type = 'text/javascript';　　　　
            script.async = 'async';　　　　
            script.src = url;　　　　
            document.body.appendChild(script);　　　　
            if (script.readyState) { //IE
                script.onreadystatechange = function() {　　　　　　　　
                    if (script.readyState == 'complete' || script.readyState == 'loaded') {　　　　　　　　　　
                        script.onreadystatechange = null;　　　　　　　　　　
                        resolve('js加载完成');　　
                    }　　　　　　
                }　　　　
            } else { //非IE
                script.onload = function() {
                    resolve('js加载完成');
                }　　　　
            }
        });
    }

    function pLoadMp3(music) {
        return new Promise(function(resolve, reject) {
            music.addEventListener('canplay', function() {
                //数据已经可以播放(当前位置已经加载) 但没有数据能播放下一帧的内容
                if (music.readyState >= 2) {
                    resolve('music加载完成');
                }
            }, false);
        });
    }

    //当音频和视频同时加载ok，在播放
    function playViode() {
        //音频
        music.play();
        document.addEventListener("WeixinJSBridgeReady", function() {
            WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
                music.play();
            });
        }, false);

        //图片
        run(imgData.key, function(timer) {
            clearInterval(timer);
            alert('播完了！')
        });
    }

    Promise.all([
        pLoadJs('./dist/base64.js'),
        pLoadMp3(music)
    ]).then(function(posts) {
        console.log('资源都加载好了！');
        alert('资源都加载好了！');
        playViode();
    }).catch(function(reason) {
        alert(JSON.stringify(reason));
    })
````

video.pm4视频有770KB，转码后base64.js有512KB，音频文件有157KB
最后静态资源都上传到了cdn上面

* <a href="http://1251097942.cdn.myqcloud.com/1251097942/cd/zs/mp4-to-base64/index.html" target="_blank">页面效果预览</a>

* <a href="https://github.com/zhongs/mp4-to-base64" target="_blank">项目源码地址</a>

## 总结
* 这种方式能解决安卓手机全屏播放问题
* 转码文件资源很大，第一次进页面比较慢
* 视频画面质量有所下降